
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Servicios técnicos cercanos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.css" />
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    .filtros {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: white;
      padding: 10px;
      border-radius: 6px;
      z-index: 1;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      font-family: sans-serif;
      font-size: 14px;
    }
    .filtros label {
      display: block;
      margin-top: 5px;
    }
    .filtros select {
      width: 200px;
      padding: 4px;
    }
  </style>
</head>
<body>
  <div class="filtros">
    <label for="provinciaFilter">Provincia:</label>
    <select id="provinciaFilter">
      <option value="">Todas las provincias</option>
    </select>

    <label for="ciudadFilter">Ciudad:</label>
    <select id="ciudadFilter">
      <option value="">Todas las ciudades</option>
    </select>
  </div>
  <div id="map"></div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoibmljb3BlbmFmbG9yIiwiYSI6ImNtY3Q5NGRnZDAybzUybHBrODR3aDQ3OWMifQ.JIQvtVoxOsfZQB5c7K-fMg';

    const servicePoints = [
      { name: 'World Machine', provincia: 'Córdoba', ciudad: 'Villa Carlos Paz', coords: [-64.5036822, -31.4421998] },
      { name: 'AVR TOOLS', provincia: 'Córdoba', ciudad: 'Río Ceballos', coords: [-64.159612, -31.4331269] },
      { name: 'JMA - Servicio Técnico', provincia: 'Córdoba', ciudad: 'Córdoba Capital', coords: [-64.1546398, -31.4060684] }
      // Aquí puedes seguir agregando todos los servicePoints
    ];

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [-58.38, -34.6],
      zoom: 4
    });

    const provinciaFilter = document.getElementById('provinciaFilter');
    const ciudadFilter = document.getElementById('ciudadFilter');

    const provincias = [...new Set(servicePoints.map(s => s.provincia))];
    provincias.forEach(prov => {
      const opt = document.createElement('option');
      opt.value = prov;
      opt.textContent = prov;
      provinciaFilter.appendChild(opt);
    });

    provinciaFilter.addEventListener('change', () => {
      ciudadFilter.innerHTML = '<option value="">Todas las ciudades</option>';
      const ciudades = [...new Set(servicePoints
        .filter(s => provinciaFilter.value === '' || s.provincia === provinciaFilter.value)
        .map(s => s.ciudad))];
      ciudades.forEach(ci => {
        const opt = document.createElement('option');
        opt.value = ci;
        opt.textContent = ci;
        ciudadFilter.appendChild(opt);
      });
      renderMarkers();
    });

    ciudadFilter.addEventListener('change', renderMarkers);

    function renderMarkers(clientLocation = null) {
      document.querySelectorAll('.mapboxgl-marker').forEach(m => m.remove());
      servicePoints
        .filter(s => (provinciaFilter.value === '' || s.provincia === provinciaFilter.value) &&
                     (ciudadFilter.value === '' || s.ciudad === ciudadFilter.value))
        .forEach(p => {
          const coordsInvertidos = [p.coords[0], p.coords[1]];
          const distance = clientLocation
            ? turf.distance(turf.point(clientLocation), turf.point(coordsInvertidos), { units: 'kilometers' }).toFixed(2)
            : null;
          new mapboxgl.Marker()
            .setLngLat(coordsInvertidos)
            .setPopup(new mapboxgl.Popup().setText(distance ? `${p.name} - ${distance} km` : p.name))
            .addTo(map);
        });
    }

    renderMarkers();

    const geocoder = new MapboxGeocoder({
      accessToken: mapboxgl.accessToken,
      mapboxgl: mapboxgl,
      placeholder: 'Ingresá tu dirección...',
      marker: false
    });
    map.addControl(geocoder);

    geocoder.on('result', function(e) {
      const clientLocation = e.result.center;
      new mapboxgl.Marker({ color: 'blue' })
        .setLngLat(clientLocation)
        .setPopup(new mapboxgl.Popup().setText('Tu ubicación'))
        .addTo(map);
      renderMarkers(clientLocation);
    });
  </script>
</body>
</html>
